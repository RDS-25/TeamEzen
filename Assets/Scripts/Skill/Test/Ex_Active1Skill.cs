using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using System;
using System.IO;
public class Ex_Active1Skill : ActiveSkill
{
    private string _strExActive1SkillPath;//파일경로
    string ActiveParams;
    public Skilldatas scriptabledata;//스크립터블오브젝트 인스펙터창
    public Charater1 Charater1;    
    Dictionary<string, string> dictActive1SkillStat;//딕셔너리 사용
    //public Action skillTirger;
    public Transform FirePoint;
    public GameObject EffectPrefab;
    //스킬레벨업 변수들 스킬마다 써주기
    const float PLUS_VAL = 10f;
    const float PLUS_MAG = 10f;
    const float PLUS_TARGET_COUNT = 0f;
    const float PLUS_ATTACK_COUNT = 0f;



    void Start()
    {
        _strExActive1SkillPath = Application.persistentDataPath + "/ActiveSkill/";//폴더명
        ActiveParams = FileName.STR_JSON_ACTIVESKILL1_PARAS;//파일명 추가
        LevelUpValue();
        InitParams();
    }
    public override void InitParams()
    {//데이터파일 있으면 LoadParams() 없으면 SetParams()

        if (GameManager.instance.CheckExist(_strExActive1SkillPath, ActiveParams))
        {
            LoadParams();
        }
        else
        {
            SetDefault();
            SetParams();
        }
    }
    void LevelUpValue()
    {
        plusval = PLUS_VAL;
        pulsmag = PLUS_MAG;
        plustargetcount = PLUS_TARGET_COUNT;
        plusattackcount = PLUS_ATTACK_COUNT;
    }
    public void SetDefault()
    {//스크립터블 지우고 새로 설정하기
        SkillParameter.SkilParams scriptable = scriptabledata.Skills[0];
        fSkillLevel = scriptable.fSkillLevel;
        fId = scriptable.fId;
        strName = scriptable.strName;//스크립터블 오브젝트에서 꺼내올때
        strDiscription = scriptable.strDiscription;
        fSkillExp = scriptable.fSkillExp;
        fSkillRequireExp = scriptable.fSkillRequireExp;
        fUnlockLevel = scriptable.fUnlockLevel;
        fUnlockHidenLevel = scriptable.fUnlockHidenLevel;
        fTimer = scriptable.fTimer;
        fCoolTime = scriptable.fCoolTime;
        fDuration = scriptable.fDuration;
        fSkillCoolReduce = scriptable.fSkillCoolReduce;
        fRange = scriptable.fRange;
        fValue = scriptable.fValue;
        fHidenValue = scriptable.fHidenValue;
        fMagnification = scriptable.fMagnification;
        fTargetCount = scriptable.fTargetCount;
        fAttackCount = scriptable.fAttackCount;
        fBulletCount = scriptable.fBulletCount;
        bisUnlockSkill = scriptable.bisUnlockSkill;
        bisUnlockHiden = scriptable.bisUnlockHiden;
        bisCanUse = scriptable.bisCanUse;
        bisActtivate = scriptable.bisActtivate;
    }
    public override void SetParams()
    {      
            Dictionary<string, string> dictTemp = new Dictionary<string, string>();
            dictTemp.Add("fSkillLevel", fSkillLevel.ToString());
            dictTemp.Add("fId", fId.ToString());
            dictTemp.Add("strName", strName);
            dictTemp.Add("strDiscription", strDiscription);
            dictTemp.Add("fSkillExp", strDiscription);
            dictTemp.Add("fSkillRequireExp", fSkillRequireExp.ToString());
            dictTemp.Add("fUnlockLevel", fUnlockLevel.ToString());
            dictTemp.Add("fUnlockHidenLevel", fUnlockHidenLevel.ToString());
            dictTemp.Add("fTimer", fTimer.ToString());
            dictTemp.Add("fCoolTime", fCoolTime.ToString());
            dictTemp.Add("fDuration", fDuration.ToString());
            dictTemp.Add("fSkillCoolReduce", fSkillCoolReduce.ToString());
            dictTemp.Add("fRange", fRange.ToString());
            dictTemp.Add("fValue", fValue.ToString());
            dictTemp.Add("fHidenValue", fHidenValue.ToString());
            dictTemp.Add("fMagnification", fMagnification.ToString());
            dictTemp.Add("fTargetCount", fTargetCount.ToString());
            dictTemp.Add("fAttackCount", fAttackCount.ToString());
            dictTemp.Add("fBulletCount", fBulletCount.ToString());
            dictTemp.Add("bisUnlockSkill", bisUnlockSkill.ToString());
            dictTemp.Add("bisUnlockHiden", bisUnlockHiden.ToString());
            dictTemp.Add("bisCanUse", bisCanUse.ToString());
            dictTemp.Add("bisActtivate", bisActtivate.ToString());
            // 이펙트이름

            GameManager.instance.DataWrite(_strExActive1SkillPath, dictTemp);

        
        
    }
    public override void LoadParams()
    {
        Dictionary<string, string> dictTemp = GameManager.instance.DataRead(_strExActive1SkillPath);
        fSkillLevel        = float.Parse(dictTemp["fSkillLevel"]);
        fId                = float.Parse(dictTemp["fId"]);
        strName            = dictTemp["strName"];
        fSkillExp          = float.Parse(dictTemp["fSkillExp"]);
        fSkillRequireExp   = float.Parse(dictTemp["fSkillRequireExp"]);
        strDiscription     = dictTemp["strDiscription"];
        fUnlockLevel       = float.Parse(dictTemp["fUnlockLevel"]);
        fUnlockHidenLevel  = float.Parse(dictTemp["fUnlockHidenLevel"]);
        fTimer             = float.Parse(dictTemp["fTimer"]);
        fCoolTime          = float.Parse(dictTemp["fCoolTime"]);
        fDuration          = float.Parse(dictTemp["fDuration"]);
        fSkillCoolReduce   = float.Parse(dictTemp["fSkillCoolReduce"]);
        fRange             = float.Parse(dictTemp["fRange"]);
        fValue             = float.Parse(dictTemp["fValue"]);
        fHidenValue        = float.Parse(dictTemp["fHidenValue"]);
        fMagnification     = float.Parse(dictTemp["fMagnification"]);
        fTargetCount       = float.Parse(dictTemp["fTargetCount"]);
        fAttackCount       = float.Parse(dictTemp["fAttackCount"]);
        fBuffDuration      = float.Parse(dictTemp["fBulletCount"]);
        bisUnlockSkill     = Convert.ToBoolean(dictTemp["bisUnlockSkill"]);
        bisUnlockHiden     = Convert.ToBoolean(dictTemp["bisUnlockHiden"]);
        bisCanUse          = Convert.ToBoolean(dictTemp["bisCanUse"]);
        bisActtivate       = Convert.ToBoolean(dictTemp["bisActtivate"]);
    }
    public override void SkillExpUp(float exp)
    {
        fSkillExp += exp;
        if(fSkillExp>= fSkillRequireExp)
        {
            SkillLevelUp();
            fSkillExp -= fSkillRequireExp;
            SetParams();
            // dictActive1SkillStat.Add("fSkillExp", fSkillExp.ToString());


            // GameManager.instance.DataWrite()
        }
        else
            SetParams();
        //dictActive1SkillStat.Add("fSkillExp", fSkillExp.ToString());
    }
    public override void SkillLevelUp()
    {

        if (fSkillLevel % 5 == 0)
            checkLevel = 1f;
        else
            checkLevel = 0f;

        plusval = PLUS_VAL + (checkLevel * 10f);
        pulsmag = PLUS_MAG + (checkLevel * 10f);
        plusattackcount = PLUS_ATTACK_COUNT + (checkLevel * 1f);
        plustargetcount = PLUS_TARGET_COUNT + (checkLevel * 1f);

        fSkillLevel++;//레벨
        fValue += plusval;//기본대미지
        fMagnification += pulsmag;//대미지상승량
        fSkillRequireExp += fSkillLevel * 10;//요구경험치 증가
        fAttackCount += plusattackcount;//타격횟수 증가
        fTargetCount += plustargetcount;//타겟수 증가

        SetParams();
        SkillHidenUnlock();
        SkillUnlock();
    }
    public override void SkillUnlock()
    {
        if (Charater1.Level > fUnlockLevel)
        {
            bisUnlockSkill = true;
            dictActive1SkillStat.Add("bisUnlockSkill", true.ToString());
            
        }
        SetParams();
        //추가기능

    }
    public override void SkillHidenUnlock()
    {
        if (Charater1.Level > fUnlockHidenLevel)
        {
            bisUnlockHiden = true;
            dictActive1SkillStat.Add("bisUnlockHiden", true.ToString());
        }
        SetParams();
        //추가기능

    }
    public override void SkillTriger()
    {//이펙트 나가게
        if(bisCanUse==true|| bisActtivate == false)
        {
            bisCanUse = false;

            bisActtivate = true;

            fTimer = 0f;
            
            EffectStart();//이펙트 있는 스킬인 경우
            StartCoroutine(SkillCoolDown());
        }

        //skillTirger?.Invoke();
    }
    
   public override IEnumerator SkillCoolDown()
    {
        yield return new WaitForSeconds(fCoolTime);
        bisCanUse = true;
        bisActtivate = false;
    }
    
    public void EffectStart()
    {
        EffectPrefab.GetComponent<Ex_Active1Effect>().fRange = this.fRange;//이펙트의 사거리
        Instantiate(EffectPrefab, FirePoint.position, FirePoint.rotation);//팩토리로 바꾸기
    }
   
}
